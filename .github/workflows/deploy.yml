name: Deploy Hexo to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: deploy/package-lock.json

      - name: Install dependencies
        run: |
          cd deploy
          npm ci

      - name: Create symlinks for blog posts
        run: |
          set -euo pipefail

          # 在 runner 上确保从项目根目录执行
          cd "$GITHUB_WORKSPACE"

          posts_dir="deploy/source/_posts"
          mkdir -p "$posts_dir"
          rm -f "$posts_dir"/*.md || true

          # 扫描整个仓库（排除 deploy/trash/prompt/.git/node_modules）
          while IFS= read -r -d '' f; do
            relative_path="${f#"$GITHUB_WORKSPACE"/}"

            case "$relative_path" in
              deploy/*|trash/*|prompt/*|.git/*|*node_modules/*)
                continue
                ;;
            esac

            # 扁平化文件名：目录1/目录2/文件.md -> 目录1_目录2_文件.md
            link_name="${relative_path%.md}"
            link_name="${link_name//\//_}.md"

            # 用绝对路径创建 symlink（更稳，不依赖相对路径深度）
            ln -sf "$f" "$posts_dir/$link_name"
          done < <(find "$GITHUB_WORKSPACE" -name "*.md" -type f -print0)

          echo "Created symlinks under $posts_dir"

      - name: Copy images to Hexo source
        run: |
          cd "$GITHUB_WORKSPACE"
          # 使用 rsync 高效复制图片文件（自动处理目录结构）
          rsync -av --include='*/' --include='*.png' --include='*.jpg' --include='*.jpeg' --include='*.gif' --include='*.svg' \
            --exclude='deploy/' --exclude='trash/' --exclude='prompt/' --exclude='.git/' --exclude='node_modules/' \
            --exclude='*' \
            ./ deploy/source/
          echo "Images synced to deploy/source/"

      - name: Generate static files
        run: |
          cd deploy
          npm run build

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./deploy/public
          branch: gh-pages
          cname: false

