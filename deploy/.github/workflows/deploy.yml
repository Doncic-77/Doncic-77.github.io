name: Deploy Hexo to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          cd deploy
          npm install

      - name: Create symlinks for blog posts
        run: |
          cd deploy/source/_posts
          rm -f *.md
          
          # 遍历所有非 deploy 目录，包括嵌套目录
          find ../.. -name "*.md" -type f | while read -r f; do
            # 获取相对于项目根目录的路径
            relative_path=$(echo "$f" | sed 's|^\.\./\.\./||')
            
            # 跳过 deploy 目录中的文件
            if [[ "$relative_path" == deploy/* ]]; then
              continue
            fi
            
            # 跳过 .git 目录
            if [[ "$relative_path" == .git/* ]]; then
              continue
            fi
            
            # 跳过 node_modules 目录
            if [[ "$relative_path" == *node_modules* ]]; then
              continue
            fi
            
            # 将路径转换为链接名：目录1/目录2/文件.md -> 目录1_目录2_文件.md
            # 移除 .md 扩展名，替换路径分隔符为下划线
            link_name=$(echo "$relative_path" | sed 's|\.md$||' | sed 's|/|_|g')
            link_name="${link_name}.md"
            
            # 创建符号链接（从 deploy/source/_posts/ 到项目根目录需要 ../../../）
            ln -sf "../../../$relative_path" "$link_name"
          done
          
          echo "Created symlinks for all markdown files"

      - name: Generate static files
        run: |
          cd deploy
          npm run clean
          npm run build

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./deploy/public
          cname: false

